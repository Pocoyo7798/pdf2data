from typing import Any, Dict, List, Optional

import fitz
import importlib_resources

from pdf2data.block import (BlockExtractor, Figure, Table, TableReconstructor,
                            TableWords)


def test_TableWords():
    file_path: str = str(
        importlib_resources.files("pdf2data") / "resources" / "test.pdf"
    )
    document = fitz.open(file_path)
    page: Any = document[2]
    table_box: List[float] = [
        30.076650027310833,
        86.22508175565758,
        563.0077171396165,
        156.38635419585557,
    ]
    word_extractor: TableWords = TableWords()
    pdf_size = [0, 0, 595.276, 793.701]
    words = word_extractor.get_words(pdf_size, page, table_box)
    structure = word_extractor.table_struture_with_boxes(
        words["boxes"], words["table_box"]
    )
    assert len(words["words"]) > 15
    assert len(structure["collumns"]) > 3


def test_block_extractor():
    file_path: str = str(
        importlib_resources.files("pdf2data") / "resources" / "test.pdf"
    )
    output_folder = str(importlib_resources.files("pdf2data") / "resources")
    extractor: BlockExtractor = BlockExtractor()
    extractor.model_post_init(None)
    layout: Dict[str, Any] = {
        "boxes": [
            [
                [
                    196.6723031138705,
                    63.72590509319696,
                    351.4967530898402,
                    85.70264264812859,
                ],
                [
                    193.472889150119,
                    100.14896084557357,
                    361.5383030244211,
                    110.37704420601982,
                ],
                [
                    108.52373547754436,
                    147.54793392558196,
                    478.85326029759767,
                    186.37123594447547,
                ],
                [
                    172.32697906043938,
                    194.5787571249203,
                    412.55813609526143,
                    207.41384563038105,
                ],
                [
                    132.61187452670077,
                    214.79257370356348,
                    447.221130300538,
                    232.2067419296576,
                ],
                [
                    141.4712586957754,
                    237.1629572265625,
                    438.3759695078101,
                    247.4197003422951,
                ],
                [
                    33.757107914916546,
                    284.3124619115713,
                    67.33750548076515,
                    294.7282013086436,
                ],
                [
                    34.38653350564387,
                    302.0095806844906,
                    560.0981964540862,
                    376.13748299236687,
                ],
                [
                    34.01103362426388,
                    385.216946194894,
                    241.286169110779,
                    394.0508296775351,
                ],
                [
                    34.32428014878408,
                    429.9398736691845,
                    100.45254602412416,
                    441.4981585424307,
                ],
                [
                    34.8654658896505,
                    455.6952060741191,
                    285.2480003893851,
                    671.6367184993821,
                ],
                [
                    44.359111048245225,
                    705.9727970160037,
                    200.25694541892406,
                    715.6950999576491,
                ],
                [
                    35.795120045967515,
                    726.5162062729194,
                    273.4583261103232,
                    744.7279483557876,
                ],
                [
                    467.81855624504044,
                    52.192600014324576,
                    553.5253490865539,
                    100.71458731527524,
                ],
                [
                    448.95838117584265,
                    111.03146209081534,
                    554.6770142218556,
                    119.6752948159977,
                ],
                [
                    301.1966777786568,
                    430.3340139603595,
                    554.1640061427788,
                    465.24640731076613,
                ],
                [
                    302.43100324630274,
                    477.25498758021763,
                    374.19961216593765,
                    489.4994808065609,
                ],
                [
                    302.86673281111246,
                    502.4015336156728,
                    407.04460625814784,
                    513.5183110590721,
                ],
                [
                    302.336788480046,
                    526.1759705237564,
                    554.6230642414577,
                    634.4032914142219,
                ],
                [
                    298.7591535217949,
                    633.1920460110412,
                    554.7381253152868,
                    715.9655935621612,
                ],
            ],
            [
                [
                    40.67237345760765,
                    64.83981827647929,
                    294.0192874915274,
                    185.00606931052695,
                ],
                [
                    42.94402513884575,
                    196.53093794169524,
                    131.2504942192253,
                    207.99114911038149,
                ],
                [
                    43.16661823284698,
                    222.58859835927535,
                    293.92052563816054,
                    546.3681687051578,
                ],
                [
                    42.971274711599655,
                    554.5467774762835,
                    137.40930404378943,
                    566.688934834383,
                ],
                [
                    42.50570351471722,
                    581.3865888696788,
                    295.26534312592105,
                    746.7136772341358,
                ],
                [
                    306.41482268645024,
                    65.28266587119589,
                    565.0301824064059,
                    87.92704720029248,
                ],
                [
                    312.45590249475106,
                    125.10998192624463,
                    400.63527829374334,
                    136.63360925716478,
                ],
                [
                    310.5926072434191,
                    149.57236281078107,
                    563.5186164246712,
                    279.57442984943,
                ],
                [
                    310.2959043178351,
                    279.8418916055485,
                    562.459826092758,
                    444.8445721918846,
                ],
                [
                    309.06735606714545,
                    447.7393283103476,
                    563.815912448574,
                    531.6626055001395,
                ],
                [
                    318.93378823147714,
                    546.6423532555406,
                    548.0155975053964,
                    721.0797505844428,
                ],
                [
                    312.5099842747754,
                    726.5341776641222,
                    562.940323597328,
                    745.2787780871333,
                ],
            ],
            [
                [
                    182.5553439821107,
                    46.322579020597495,
                    403.6602993851907,
                    56.2016153422453,
                ],
                [
                    33.96362420032506,
                    65.38718225359236,
                    56.87441640781463,
                    73.83830586149256,
                ],
                [
                    31.997335778454335,
                    74.73239355879804,
                    268.93970771953764,
                    84.01011328237105,
                ],
                [
                    30.076650027310833,
                    86.22508175565758,
                    563.0077171396165,
                    156.38635419585557,
                ],
                [
                    30.268396517088217,
                    110.48195055442342,
                    557.7829602838998,
                    322.3206800507215,
                ],
                [
                    32.83684997363015,
                    161.71773876155933,
                    476.15106042436184,
                    170.88551004103059,
                ],
                [
                    33.742505614643946,
                    184.5024529284419,
                    57.96984154421011,
                    192.894631251993,
                ],
                [
                    34.1089854590936,
                    194.95716695631378,
                    226.28001281634954,
                    203.99280017662826,
                ],
                [
                    29.276398391668277,
                    205.18820527044804,
                    552.9332612316496,
                    306.0371496063855,
                ],
                [
                    32.423644415803516,
                    353.0577348249163,
                    286.912366071302,
                    449.1183799311424,
                ],
                [
                    32.8117805863626,
                    447.8550218874562,
                    288.56480388703164,
                    519.3721512097418,
                ],
                [
                    96.63270728579685,
                    530.2448868273676,
                    492.0614719887748,
                    730.0680386360012,
                ],
                [
                    83.39732290498117,
                    735.8735449716996,
                    497.70429725936646,
                    745.3318574039382,
                ],
                [
                    302.1443170923235,
                    352.5167256459762,
                    554.4329652470101,
                    472.374151064752,
                ],
                [
                    303.84778333006625,
                    472.88429251185823,
                    554.3301615384343,
                    519.0798634486607,
                ],
            ],
            [
                [
                    145.42898180989977,
                    59.05594132298061,
                    455.46967811785584,
                    222.7789017707669,
                ],
                [
                    183.23786834731555,
                    227.6652527351224,
                    418.793137087175,
                    237.10177101079202,
                ],
                [
                    42.43985038056194,
                    256.28005757359097,
                    294.91811701022493,
                    398.0029099684112,
                ],
                [
                    43.48077087979853,
                    400.6826684899155,
                    295.0591206438463,
                    726.5547854452328,
                ],
                [
                    41.287045727657144,
                    711.8487389020647,
                    292.87069768084115,
                    745.8651112025669,
                ],
                [
                    309.89483805476306,
                    256.379163864198,
                    564.1880267270514,
                    544.6849655686982,
                ],
                [
                    318.5708999268463,
                    558.5274186578245,
                    542.1288989927945,
                    716.8966346580038,
                ],
                [
                    310.87538334181573,
                    725.9537324861487,
                    559.3624470064285,
                    745.3634940828285,
                ],
            ],
            [
                [
                    48.110713275840226,
                    63.019209793526784,
                    521.7350595378391,
                    232.55101051174864,
                ],
                [
                    49.74094285452495,
                    64.02866701168138,
                    276.4867300588476,
                    229.40017305360135,
                ],
                [
                    32.28226460408184,
                    238.9515500495755,
                    285.9262851999414,
                    267.2840634386958,
                ],
                [
                    31.190145441648024,
                    280.7386376626774,
                    284.90428893039245,
                    315.5847917166574,
                ],
                [
                    33.2855261059061,
                    328.0455567950813,
                    178.26164165374126,
                    339.4114730847417,
                ],
                [
                    33.80282316449129,
                    354.84661325683595,
                    284.4165424463717,
                    674.3029435526946,
                ],
                [
                    32.832522552564036,
                    674.5467217394771,
                    283.72879002932046,
                    746.5883608338648,
                ],
                [
                    311.48792210541325,
                    70.85035335979852,
                    535.5366331469756,
                    231.4384759406888,
                ],
                [
                    299.4480482022748,
                    239.48427657022282,
                    551.1002798943848,
                    258.1712718737544,
                ],
                [
                    304.66292008601306,
                    279.8630266646405,
                    552.7132437220138,
                    302.83112371950733,
                ],
                [
                    301.98848600073444,
                    303.62707180250516,
                    554.7125122545604,
                    473.34825319575094,
                ],
                [
                    301.67475895674306,
                    472.78191270378267,
                    554.6716983035916,
                    744.8888560198103,
                ],
            ],
            [
                [
                    42.773031598572,
                    65.22371509436783,
                    67.02201012511985,
                    73.80815215192523,
                ],
                [
                    40.65545642639677,
                    74.93162774110132,
                    350.9557156235535,
                    83.92819845095265,
                ],
                [
                    39.32410995878245,
                    87.88858886251644,
                    558.9322969591354,
                    174.52002618258732,
                ],
                [
                    46.545927703303896,
                    176.923897485227,
                    444.8642015152069,
                    186.0681609546895,
                ],
                [
                    42.09856073970403,
                    206.46221872334382,
                    290.1005990334156,
                    523.0240345698143,
                ],
                [
                    40.634689747765385,
                    519.8362437131298,
                    292.545569969168,
                    541.9955842240314,
                ],
                [
                    54.978561157115855,
                    559.2047951047314,
                    282.4340344329797,
                    719.2243033073581,
                ],
                [
                    43.573318929946694,
                    726.361362305684,
                    292.87915482353384,
                    744.626447344348,
                ],
                [
                    310.13776673278437,
                    208.8127580551459,
                    563.1957512732508,
                    329.61137467090845,
                ],
                [
                    311.80883222904225,
                    329.52562608916617,
                    563.6237046601043,
                    398.9167266501913,
                ],
                [
                    311.2476513865239,
                    414.2207064243862,
                    374.4430460758601,
                    425.92118059331153,
                ],
                [
                    309.89319055943326,
                    439.6464461510483,
                    563.6638596129411,
                    580.3224979631697,
                ],
                [
                    311.82974443642775,
                    596.2410202248087,
                    394.9175908353683,
                    607.8025127057757,
                ],
                [
                    310.35172145960667,
                    621.2138281653579,
                    563.9191554892377,
                    667.5325185108419,
                ],
                [
                    311.5122171698758,
                    682.6913650206274,
                    357.9344179739162,
                    693.965315242347,
                ],
                [
                    312.0694879568116,
                    706.7797520268655,
                    559.389509863045,
                    743.1832875089684,
                ],
            ],
            [
                [
                    184.35376086735755,
                    45.42118632625658,
                    404.0239784875798,
                    55.70207437955896,
                ]
            ],
        ],
        "scores": [
            [
                0.9707549214363098,
                0.9975165128707886,
                0.985436737537384,
                0.9966040849685669,
                0.9820467233657837,
                0.853320837020874,
                0.9938876032829285,
                0.9981058835983276,
                0.9858123064041138,
                0.9950913190841675,
                0.9983963370323181,
                0.8909792304039001,
                0.9664693474769592,
                0.7584196925163269,
                0.9901739358901978,
                0.9578947424888611,
                0.9799956679344177,
                0.9643620848655701,
                0.9994090795516968,
                0.9989194869995117,
            ],
            [
                0.9964840412139893,
                0.9803022146224976,
                0.9979737401008606,
                0.9702548384666443,
                0.9982640147209167,
                0.8689431548118591,
                0.9165747165679932,
                0.998359739780426,
                0.998921275138855,
                0.9976176619529724,
                0.9929264187812805,
                0.998474657535553,
            ],
            [
                0.7423661351203918,
                0.9533692002296448,
                0.9987936019897461,
                0.9786640405654907,
                0.7251697778701782,
                0.9906818866729736,
                0.8510212898254395,
                0.9920915365219116,
                0.9925622344017029,
                0.9983195662498474,
                0.998654842376709,
                0.9969574213027954,
                0.9458406567573547,
                0.998752236366272,
                0.9973922967910767,
            ],
            [
                0.9964169263839722,
                0.9919832348823547,
                0.9993487000465393,
                0.9982436895370483,
                0.9859994053840637,
                0.9972954392433167,
                0.9946832060813904,
                0.9985731840133667,
            ],
            [
                0.7392856478691101,
                0.9944869875907898,
                0.9980927109718323,
                0.9084619879722595,
                0.9190754890441895,
                0.9970409274101257,
                0.998219907283783,
                0.9904001355171204,
                0.9992997646331787,
                0.8242337703704834,
                0.9985949397087097,
                0.9980219602584839,
            ],
            [
                0.9043894410133362,
                0.9987161159515381,
                0.9961827397346497,
                0.9931683540344238,
                0.9960636496543884,
                0.9980486631393433,
                0.9942846894264221,
                0.9992190599441528,
                0.9991443157196045,
                0.9987425208091736,
                0.9968673586845398,
                0.9971513152122498,
                0.9963548183441162,
                0.9727760553359985,
                0.9673715829849243,
                0.9558245539665222,
            ],
            [0.9405461549758911],
        ],
        "types": [
            [
                "Title",
                "Text",
                "Title",
                "Text",
                "Text",
                "Text",
                "Title",
                "Text",
                "Text",
                "Title",
                "Text",
                "Text",
                "Text",
                "Title",
                "Text",
                "Text",
                "Title",
                "Title",
                "Text",
                "Text",
            ],
            [
                "Text",
                "Title",
                "Text",
                "Title",
                "Text",
                "Text",
                "Title",
                "Text",
                "Text",
                "Text",
                "Figure",
                "Text",
            ],
            [
                "Text",
                "Title",
                "Text",
                "Table",
                "Table",
                "Text",
                "Title",
                "Text",
                "Table",
                "Text",
                "Text",
                "Figure",
                "Text",
                "Text",
                "Text",
            ],
            ["Figure", "Text", "Text", "Text", "Text", "Text", "Figure", "Text"],
            [
                "Figure",
                "Figure",
                "Text",
                "Text",
                "Title",
                "Text",
                "Text",
                "Figure",
                "Text",
                "Text",
                "Text",
                "Text",
            ],
            [
                "Title",
                "Text",
                "Table",
                "Text",
                "Text",
                "Text",
                "Figure",
                "Text",
                "Text",
                "Text",
                "Title",
                "Text",
                "Title",
                "Text",
                "Title",
                "Text",
            ],
            ["Text"],
        ],
        "page_type": [
            "Only Text",
            "Image",
            "Table and Image",
            "Image",
            "Image",
            "Table and Image",
            "Only Text",
        ],
    }
    extractor.get_blocks(file_path, layout, output_folder)
